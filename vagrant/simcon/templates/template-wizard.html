{% extends "admin/base_site.html" %}
{% load staticfiles %}

{% block title %}
Admin | Template Wizard
{% endblock %}
{% block branding %}
<h1 id="site-name">Simcon administration | Template Wizard</h1>
{% endblock %}

{% block extrahead %}
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Created for Simulated Conversations Senior Capstone Project">
    <meta name="author" content="Nathanial Myers, Nick Horner">

    <!-- Bootstrap core CSS -->
    <link href="{% static "dist/css/bootstrap.css" %}" rel="stylesheet">

    <!-- prevent line breaks when using form fields -->
    <style type="text/css">
    form {display:inline; margin:0px; padding:0px;}
    </style>

    <!-- jQuery addition -->
    <script type="text/javascript" src="http://code.jquery.com/jquery-2.1.0.js"></script>


    <script>

    $(document).ready(function(){
	
	  <!-- the snippet below ensures the AJAX POST has a CSRF token for django -->
      $(document).ajaxSend(function(event, xhr, settings) {
	    function getCookie(name) {
	      var cookieValue = null;
	      if (document.cookie && document.cookie != '') {
		   var cookies = document.cookie.split(';');
		   for (var i = 0; i < cookies.length; i++) {
		      var cookie = jQuery.trim(cookies[i]);
		      // Does this cookie string begin with the name we want?
		      if (cookie.substring(0, name.length + 1) == (name + '=')) {
			    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
			    break;
		      }
		   }
	      }
	      return cookieValue;
	    }
	  function sameOrigin(url) {
	      // url could be relative or scheme relative or absolute
	      var host = document.location.host; // host + port
	      var protocol = document.location.protocol;
	      var sr_origin = '//' + host;
	      var origin = protocol + sr_origin;
	      // Allow absolute or scheme relative URLs to same origin
	      return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
		  (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
		  // or any other URL that isn't scheme relative or absolute i.e relative.
		  !(/^(\/\/|http:|https:).*/.test(url));
	  }
	  function safeMethod(method) {
	      return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
	  }

	  if (!safeMethod(settings.type) && sameOrigin(settings.url)) {
	      xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
	  }
      });
      <!-- end snippet -->
      
      <!-- here's the ajax/jquery code to remove a video from pool-->
      $("#leftPane").on("click", "button.removeVideoButton", function(){
           var removeVideoFromPool = $(this).val();
           var data = { removeVideoFromPool:removeVideoFromPool };
           var args = { type:"POST", url:"{% url 'TemplateWizardUpdate' %}", data:data, cache:false, complete:function(){
                           $("#leftPane").load("{% url 'TemplateWizardLeftPane' %}")
                           <!-- check if its the video to be deleted, and load the empty right pane if so -->
                           $("#rightPane").load("{% url 'TemplateWizardRightPane' %}")
                       } };
           $.ajax(args);
      });
      <!-- here's the code to add a video to the pool -->
      $("#leftPane").on("click", "button.addVideoButton", function(){
           var new_video = $("#video_name").val();
           var data = { new_video:new_video };
           var args = { type:"POST", url:"{% url 'TemplateWizardUpdate' %}", data:data, cache:false, complete:function(){
                            $("#leftPane").load("{% url 'TemplateWizardLeftPane' %}")
                       } };
           $.ajax(args);
      });
      <!-- select a video to edit the video/response page (by clicking button)-->
      $("#leftPane").on("click", "button.editVideoButton", function(){
          var editVideo = $(this).val();
          var data = { editVideo:editVideo };
          var args = {type:"POST", url:"{% url 'TemplateWizardUpdate' %}", data:data, cache:false, complete:function(){
                            <!-- TODO before loading right pane, check if there is data there, and save it if so -->
                            $("#rightPane").load("{% url 'TemplateWizardRightPane' %}")
                     }};
          $.ajax(args);
      });
      <!-- show instructions near top of page-->
      $("#instrucLink").on("click", "#showInstruc", function(){
          $("#instrucLink").html('<br><br><button type=button class="btn btn-default btn-xs" id=hideInstruc> Hide Instructions </button>')
          $("#instructions").html(
            '<div class="alert alert-success">'+
              'Welcome to the conversation template wizard! To begin, you will need to have videos uploaded to YouTube. You can either upload videos, find existing videos, or record new videos at <a href="http://www.youtube.com" target="new">www.YouTube.com</a>. Once your videos are on YouTube, navigate to them in your browser. You will then need to copy the web address of the video. To do this, select the web address text, right click, and click Copy. The address should look something like this: http://www.youtube.com/watch?v=iQRfqGSzIQ4 . Once you have copied the text, come back to this template wizard, and paste it into the box that says "Enter web address of YouTube video". Click Add Video. Your video should now be in the "pool" of videos. You can add more videos in this same manner. From there, you can click "Edit Video Page". You will be able to write custom text that goes on this video page, and you will be able to add responses to the video. Select the next video that a response would go to, and click "Add response". If you decide to enter custom text, make sure you click on the button to save your text. Make sure you have edited every video page, and have created response options that eventually take you to an end-point. When you are finished designing your conversation, click "Save Template" at the top of the page. '+
            '</div>')
      });
      <!-- hide instructions near top of page-->
      $("#instrucLink").on("click", "#hideInstruc", function(){
          $("#instrucLink").html('<br><br><button type=button class="btn btn-default btn-xs" id=showInstruc> Show Instructions </button>')
          $("#instructions").html(' ')
      });
      <!-- start over-->
      $("#startOverLink").on("click", "#startOver", function(){
          window.location.replace("{% url 'TemplateWizard' %}")
      });
      <!-- this function is called to save the video editor page -->
      var saveVideoPage = function(){
         var data = new Array();
         data['enablePlayback'] = $("#enablePlayback").val();
         for (res in $("$responses .response")){
            data['response'][res] = $(this)[res].val();
         }
         var args = {type:"POST", url:"{% url 'TemplateWizardUpdate' %}", data:data, cache:false, complete:function(){
                            <!-- this isnt finished... -->
                            $("#rightPane").load("{% url 'TemplateWizardRightPane' %}")
                     }};
          $.ajax(args);

      }
      <!-- add a response option on the video editor page -->
      $("#rightPane").on("click", "#addResponseButton", function(){
        if($("#addResponseChildVideo").val() != "none" && $("#addResponseText").val() != ""){
           var addResponseText = $("#addResponseText").val();
           var addResponseParentVideo = $("#addResponseParentVideo").val();
           var addResponseChildVideo = $("#addResponseChildVideo").val();
           var addResponse = "submit"; <!-- a placehold to signify in the view what action to take -->
           var data = { addResponse:addResponse, addResponseText:addResponseText, addResponseParentVideo:addResponseParentVideo, addResponseChildVideo:addResponseChildVideo };
           var args = { type:"POST", url:"{% url 'TemplateWizardUpdate' %}", data:data, cache:false, complete:function(){
                           $("#rightPane").load("{% url 'TemplateWizardRightPane' %}")
                       } };
           $.ajax(args);
        }
      });
      <!-- remove response button -->
      $("#rightPane").on("click", "#removeResponseButton", function(){
          var removeResponseId = $(this).val();
          alert("removing button: " + removeResponseId);
          var removeResponse = "removeResponse";
          var data = { removeResponse:removeResponse, removeResponseId:removeResponseId };
          var args = {type:"POST", url:"{% url 'TemplateWizardUpdate' %}", data:data, cache:false, complete:function(){
                            <!-- TODO before loading right pane, check if there is data there, and save it if so -->
                            $("#rightPane").load("{% url 'TemplateWizardRightPane' %}")
                     }};
          $.ajax(args);
      });
      <!-- save video page -->
      $("#rightPane").on("click", "#saveVideoPage", function(){
           tinyMCE.triggerSave();
           var saveVideoPage = $("#saveVideoPage").val();
           var textOfEditor = tinymce.get('id_richText').getContent();
           var data = { saveVideoPage:saveVideoPage, mce:textOfEditor };
           var args = { type:"POST", url:"{% url 'TemplateWizardUpdate' %}", data:data, cache:false, complete:function(){
                           //$("#rightPane").load("{% url 'TemplateWizardRightPane' %}")
                           //tinymce.get('id_richText').setContent(textOfEditor)
                       } };
           $.ajax(args);
      });
      <!-- enable/disable playback -->
      $("#rightPane").on("click", "#enablePlayback", function(){
           var enablePlayback = "off";
           if ($("#enablePlayback").is(":checked"))
                enablePlayback = "on";
           var vid = $("#selectedVideo").val();
           var data = { enablePlayback:enablePlayback, vid:vid };
           var args = { type:"POST", url:"{% url 'TemplateWizardUpdate' %}", data:data, cache:false, complete:function(){
                           $("#rightPane").load("{% url 'TemplateWizardRightPane' %}")
                       } };
           $.ajax(args);
      });
	});
    </script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
    <!-- tinymce -->
    
    {% endblock %}

  {% block content %}

    <div id="mainBody" class="container">
      <div class="starter-template">
        {% if request.session.error == "noFirstPage" %}
        <div class="alert alert-danger">
          Your conversation did not save. It was not clear which video comes first in the conversation flow. Check all of your video pages and make sure they all have responses, and make sure there is a clear end-point.
        </div>
        {% elif request.session.error == "noTitle" %}
        <div class="alert alert-danger">
          There was an error submitting the conversation. You did not enter a title.
        </div>
        {% elif request.session.error == "noResponses" %}
        <div class="alert alert-danger">
          There was an error submitting the conversation. One of your videos has no possible responses.
        </div>
        {% elif request.session.error == "general" %}
        <div class="alert alert-danger">
          There was an error submitting the conversation. Check all of your data and try again.
        </div>
        {% elif request.session.error == "editButResponses" %}
        <div class="alert alert-danger">
          You are trying to edit a template that has corresponding responses. You cannot edit the template. Instead, you can create a new copy. The proper values below were populated. If you'd instead like to delete the template, <a href="{% url 'TemplateDelete' request.session.editTemplateID %}">click here</a>.
        </div>
        {% endif %}
        <div class="row">
          <div class="col-md-5">
            <h2>Conversation Template Wizard</h2>
          </div>
          <div class="col-md-2" id="startOverLink">
            <br><br><button type="button" class="btn btn-default btn-xs" id="startOver"> Start Over </button>
          </div>
          <div class="col-md-2" id="instrucLink">
            <br><br><button type="button" class="btn btn-default btn-xs" id="showInstruc"> Show Instructions </button>
          </div>
          <div class="col-md-3" id="templateSaver">
            <br><form method="post" action="{% url 'TemplateWizardSave' %}">{% csrf_token %}
                <input type="hidden" name="saveTemplate" value="saveTemplate">
                <button type="button" id="saveTemplateButton" class="btn btn-default btn-lg" onclick="submit();">Save Template &raquo; 
                </button>
          </div>
        </div>
          <div id="instructions"></div>
          <div class="form-group">
          <label for="conversationTitle">Conversation Title</label>
          <input type="text" name="conversationTitle" id="conversationTitle" class="form-control" placeholder="Enter a title" 
          {% if request.session.conversationTitle != "" %}
          value="{{ request.session.conversationTitle }}"
          {% endif %}>
          </form>
          </div>
          <div class="row">
            <div class="col-md-4">
              <h4><u>Videos</u></h4>
              <div id="leftPane">
                {% include 'template-wizard-left-pane.html' %} {#url 'TemplateWizardLeftPane' #}
              </div>
            </div>
            <div class="col-md-8">
              <div class="panel panel-default">
                <div class="panel-heading videoEditorTitle" id="videoEditorTitle">
                  <h3 class="panel-title">Video Page Editor</h3>
                </div>
                <div class="panel-body">
                  <div id="rightPane">
		    {%  include 'template-wizard-right-pane.html' %}{# url 'TemplateWizardRightPane' #}
                  </div>                  
                </div>
              </div>
            </div>
          </div>
          <hr>
        <!--/form-->

      </div>

    </div><!-- /.container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="{% static "dist/js/bootstrap.min.js" %}"></script>
{% endblock %}
